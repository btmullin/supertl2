{% extends "base.html" %}
{% block content %}
<!-- Load Leaflet first -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Then load the polyline plugin -->
<script
  src="https://cdn.jsdelivr.net/npm/polyline-encoded@0.0.9/Polyline.encoded.js"
></script>

<div class="whole-body">
  <div class="section">
    <div style="display: flex; flex-direction: row; gap: 2em; flex-wrap: wrap;">

      <!-- Left: Strava Info -->
      <div style="flex: 1; min-width: 300px;">
        <h3>Strava Activity Info</h3>
        <a href="https://www.strava.com/activities/{{ activity.activityId }}" target="_blank" rel="noopener">
            View on Strava
          </a>
          <p></p>
        <table class="styled-table">
          <tbody>
            <tr><th>Start Time</th><td>{{ activity.startDateTime | pretty_datetime }}</td></tr>
            <tr><th>Sport</th><td>{{ activity.sportType }}</td></tr>
            <tr><th>Name</th><td>{{ activity.name }}</td></tr>
            <tr><th>Distance</th><td>{{ activity.distance | km }}</td></tr>
            <tr><th>Duration</th><td>{{ activity.movingTimeInSeconds | format_duration }}</td></tr>
            <tr><th>Calories</th><td>{{ activity.calories or "—" }}</td></tr>
            <tr><th>Avg HR</th><td>{{ activity.averageHeartRate or "—" }}</td></tr>
            <tr><th>Max HR</th><td>{{ activity.maxHeartRate or "—" }}</td></tr>
            <tr><th>Avg Power</th><td>{{ activity.averagePower or "—" }}</td></tr>
            <tr><th>Description</th><td>{{ activity.description or "—" }}</td></tr>
          </tbody>
        </table>
        <p></p>

        {% if summary_polyline %}
        <h4>Route</h4>
        <div id="map" style="height: 500px; margin-bottom: 1em; border-radius: 10px;"></div>

        <script>
          document.addEventListener("DOMContentLoaded", function () {
            const encoded = {{ summary_polyline | tojson }};

        
            if (!encoded) {
              console.warn("No polyline available.");
              return;
            }
        
            // Decode the polyline — returns a Leaflet Polyline
            const polyline = L.Polyline.fromEncoded(encoded);
        
            const map = L.map("map");
        
            L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
              maxZoom: 18,
            }).addTo(map);
        
            polyline.addTo(map);
            map.fitBounds(polyline.getBounds());
          });
        </script>
        
        {% endif %}

      </div>

      <!-- Right: Editable Training Log Fields -->
      <div style="flex: 1; min-width: 300px;">
        <h3>Edit Training Log Data</h3>
        <form method="POST">
          {{ form.hidden_tag() }}

          <div class="form-group">
            <label>{{ form.workoutTypeId.label }}</label>
            {{ form.workoutTypeId() }}
          </div>

          <div class="form-group">
            <label>{{ form.categoryId.label }}</label>
            {{ form.categoryId() }}
          </div>

          <div class="form-group">
            <label>{{ form.notes.label }}</label>
            {{ form.notes(rows=4) }}
          </div>

          <div class="form-group">
            <label>{{ form.tags.label }}</label>
            {{ form.tags() }}
          </div>

          <div class="form-group">
            <label>{{ form.isTraining.label }}</label>
            {{ form.isTraining() }}
          </div>

          <div>
            {{ form.submit() }}
            {{ form.cancel() }}
          </div>
          <hr>
          <div>
            {{ form.general_trail() }}
            {{ form.general_mountain_bike() }}
            {{ form.general_gravel_bike() }}
            {{ form.general_virtual_bike() }}
            {{ form.strength() }}
            {{ form.l3_skate_roller() }}
            {{ form.l3_classic_roller() }}
            {{ form.general_skate_ski() }}
            {{ form.general_classic_ski() }}
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="section">
    <canvas id="streamChart"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script>
      requestAnimationFrame(() => {
        const verticalLinePlugin = {
          id: 'hoverLine',
          afterDraw(chart, args, options) {
            const tooltip = chart.tooltip;
            const activeElements = tooltip._active || tooltip.dataPoints;
        
            if (!activeElements || activeElements.length === 0) return;
        
            const ctx = chart.ctx;
            const x = activeElements[0].element.x;
            const topY = chart.chartArea.top;
            const bottomY = chart.chartArea.bottom;
        
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(x, topY);
            ctx.lineTo(x, bottomY);
            ctx.lineWidth = options.lineWidth || 1;
            ctx.strokeStyle = options.color || 'rgba(0, 0, 0, 0.5)';
            if (options.dash) ctx.setLineDash(options.dash);
            ctx.stroke();
            ctx.restore();
          }
        };
        Chart.register(verticalLinePlugin);

        const formatTime = (seconds) => {
          const h = Math.floor(seconds / 3600);
          const m = Math.floor((seconds % 3600) / 60);
          const s = seconds % 60;
          return `${h > 0 ? h + ':' : ''}${h > 0 ? String(m).padStart(2, '0') : m}:${String(s).padStart(2, '0')}`;
        };

        const ctx = document.getElementById('streamChart').getContext('2d');

        const streamChart = new Chart(ctx,
        {
          type: 'line',
          data: {
            datasets: [
              {
                label: 'Altitude',
                data: {{ activity.getAltitudePlotData() | tojson }},
                borderWidth: 2,
                fill: true,
                yAxisID: 'y_alt',
                borderColor: 'rgb(200, 200, 200)',
                pointRadius: 0,
                tension: 0.3
              },
              {
                  label: 'Heart Rate',
                  data: {{ activity.getHRPlotData() | tojson }},
                  borderWidth: 2,
                  fill: true,
                  yAxisID: 'y_hr',
                  borderColor: 'rgb(200, 50, 50)',
                  backgroundColor: 'rgba(200, 50, 50, 0.2)',
                  pointRadius: 0,
                  tension: 0.3
                }
              ]
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                hoverLine: {
                  color: 'rgba(0, 0, 0, 0.5)', // optional: line color
                  lineWidth: 1,
                  dash: [4, 4] // optional: dashed line
                },
                legend: {
                  display: true,
                  position: 'right',
                  labels: {
                    color: 'rgb(50, 99, 132)'
                  }
                },
                tooltip: {
                  enabled: true,
                  mode: 'index',
                  intersect: false,
                }
              },
              pointHoverRadius: 5,
              responsive: true,
              scales: {
                x: {
                  type: 'linear',
                  display: true,
                  title: {
                    display: true,
                    text: 'Time (h:mm:ss)'
                  },
                  ticks: {
                    maxTicksLimit: 15,  // Reduce number of ticks
                    callback: (value, index, ticks) => formatTime(value)
                  }
                },
                y_alt: {
                  display: true,
                  position: 'right',
                  title: {
                    display: true,
                    text: 'Altitude (m)'
                  },
                  grid: {
                    color: 'rgb(200, 200, 200, .25)'
                  },
                  ticks: {
                    color: 'rgb(100, 100, 100)'
                  }
                },
                y_hr: {
                  display: true,
                  title: {
                    display: true,
                    text: 'Heart Rate (bpm)'
                  },
                  grid: {
                    color: 'rgb(200, 50, 50, .5)'
                  },
                  ticks: {
                    color: 'rgb(200, 50, 50)'
                  }
                }
              },
              interaction: {
                mode: 'index',
                intersect: false,
              },
              hover: {
                mode: 'index',
                intersect: false
              },
            },
        });
      });
    </script>
  </div>
</div>
{% endblock %}
