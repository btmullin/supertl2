{# app/templates/query.html #}
{% extends "base.html" %}
{% block content %}
<div class="whole-body">
  {% if not request.args %}
  <!-- Display the form -->
  <div class="section">
    <form method="get" action="{{ url_for('views.activity_query') }}" class="filters">
      <div>
        <label>{{ form.categories.label }}</label>
        {{ form.categories(size=6, multiple=True) }}
      </div>

      <div>
        <label>{{ form.workout_types.label }}</label>
        {{ form.workout_types(size=6, multiple=True) }}
      </div>

      <div>
        <label>{{ form.is_training.label }}</label>
        {{ form.is_training() }}
      </div>

      <div class="date-range left-fill">
        <div class="field">
          <label>{{ form.date_start.label }}</label>
          {{ form.date_start(type="date") }}
        </div>
        <div class="field">
          <label>{{ form.date_end.label }}</label>
          {{ form.date_end(type="date") }}
        </div>
        <div class="flex-spacer" aria-hidden="true"></div>
      </div>

      <div>
        <label>{{ form.min_time.label }}</label>
        {{ form.min_time(size=6) }}
      </div>
      <div>
        <label>{{ form.max_time.label }}</label>
        {{ form.max_time(size=6) }}
      </div>


      <div class="mt-1">
        {{ form.submit(class_="btn") }}
        <a class="btn btn--secondary" href="{{ url_for('views.activity_query') }}">Reset</a>
      </div>
    </form>
  </div>
  {% else %}
  <!-- Display the results -->
  <div class="section">
    <table class="styled-table">
      <thead>
        <tr>
          <th>Filter</th>
          <th>Value</th>
        </tr>
      </thead>
      {% for f in query_filter %}
        <tr>
          <td>{{ f[0] }}</td>
          <td>{{ f[1] }}</td>
        </tr>
      {% endfor %}
    </table>
  </div>
  <hr>
  <div class="section">
    <table class="styled-table">
      <thead>
        <tr>
          <th>Date/Time</th>
          <th>Sport</th>
          <th>Name</th>
          <th>Distance</th>
          <th>Time</th>
        </tr>
      </thead>
      {% for activity in activities %}
      <tr onclick="window.location='{{ url_for('views.edit_activity', id=activity.id, next=request.full_path) }}'" class="row-clickable">
        <td class="col-date-time">
          {{ activity.start_time_utc | localtime | pretty_datetime }}
        </td>
        <td class="col-sport">
          {{ activity | displaySportOrCategory }}
        </td>
        <td class="col-name">
          {{ activity.name }}
        </td>
        <td class="col-distance">
          {{ activity.distance_m | km }}
        </td>
        <td class="col-time">
          {{ activity.moving_time_s | format_duration }}
        </td>
      </tr>
      {% endfor %}
      <!-- Add the totals row -->
      <tr class="summary-row-border-header">
        <td colspan="3">{{ summary.count }} Activities</td>
        <td class="col-distance">{{ summary.total_distance | km }}</td>
        <td class="col-time">{{ summary.total_moving_s | format_duration }}</td>
      </tr>
    </table>
  </div>
  <hr>
  <div class="summary-container">
    <table class="styled-table summary-table">
      <thead>
        <tr class="summary-row-border-header">
          <th>Category</th>
          <th class="col-distance">Distance</th>
          <th class="col-time">Time</th>
        </tr>
      </thead>
      {% for cat, cat_summary in category_summary.items() %}
      <tr>
        <td class="col-name">
          <span class="category-label indent" style="--indent-level: {{ (category_depths.get(cat, 0) if category_depths else 0) }};">
            {{ cat | category_path }}
          </span>
        </td>
        <td class="col-distance">{{ cat_summary.total_distance | km }}</td>
        <td class="col-time">{{ cat_summary.total_moving_s | format_duration }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% endif %}
</div>


{% endblock %}
