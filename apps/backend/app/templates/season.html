{% extends "base.html" %}
{% block content %}

<div class="whole-body">
    <div class="section">

    {% if not seasons or seasons|length == 0 %}
        <p>No seasons defined yet. Create one in <a href="{{ url_for('views.admin_seasons') }}">Admin: Seasons</a>.</p>
    {% else %}

        <form method="get" action="{{ url_for('views.season_view') }}" style="margin: 1rem 0;">
        <label for="season_id">Season</label>
        <select id="season_id" name="season_id" onchange="this.form.submit()">
            {% for s in seasons %}
            <option value="{{ s.id }}" {% if selected_season and s.id == selected_season.id %}selected{% endif %}>
                {{ s.label if s.label is defined else s.name }}
            </option>
            {% endfor %}
        </select>
        <noscript><button type="submit" class="btn">Go</button></noscript>
        </form>

        {% if selected_season %}
        <label>{{ selected_season.name }}</label>
        <p style="opacity:0.85; margin-top:0.25rem;">
            {{ selected_season.start_date.strftime('%B %d, %Y') }}
            &ndash;
            {{ selected_season.end_date.strftime('%B %d, %Y') }}
        </p>

        {% if summary %}
            <div class="summary-container" style="margin-top: 1rem;">
            <table class="styled-table">
                <tbody>
                <tr><th>Total hours</th><td style="text-align:right;">{{ "%.1f"|format(summary.total_hours) }}</td></tr>
                <tr><th>Sessions</th><td style="text-align:right;">{{ summary.sessions }}</td></tr>
                <tr><th>Weeks</th><td style="text-align:right;">{{ summary.weeks }}</td></tr>
                <tr><th>Avg hours / week</th><td style="text-align:right;">{{ "%.1f"|format(summary.avg_hours_per_week) }}</td></tr>
                </tbody>
            </table>
            {% if summary and summary.is_in_progress %}
              <p style="opacity:0.8;">To date through {{ summary.effective_end }}</p>
            {% endif %}
            </div>
        {% endif %}

        {% set items = breakdown.get("items") if breakdown else None %}
        {% if items and items|length %}
          <div class="season-chart-container">
            <label>Activity type distribution</label>

            <div style="display:flex; gap: 1.5rem; align-items: flex-start; flex-wrap: wrap;">
              <!-- Donut -->
              <div style="width: 360px; height: 500px;">
                <canvas id="seasonDonutChart" style="width:100%; height:100%;"></canvas>
              </div>

              <!-- Table -->
              <div class="summary-container" style="margin: 0;">
                <table class="styled-table">
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th style="text-align:right;">Hours</th>
                      <th style="text-align:right;">%</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for it in items %}
                      <tr>
                        <td>{{ it["label"] }}</td>
                        <td style="text-align:right;">{{ "%.1f"|format(it["hours"]) }}</td>
                        <td style="text-align:right;">{{ "%.0f"|format(it["percent"]) }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {% endif %}

        {% if weekly and weekly.weeks and weekly.weeks|length %}
        <div class="season-chart-container" style="margin-top: 1.5rem;">
        <label>Weekly training volume</label>

        <div style="height: 260px;">
            <canvas id="seasonWeeklyChart" style="width:100%; height:100%;"></canvas>
        </div>
        </div>
        {% endif %}

        {% if compare_rows and compare_rows|length %}
          <div class="section">
            <label>Season comparison</label>

            <table class="styled-table">
              <thead>
                <tr>
                  <th>Season</th>
                  <th>Dates</th>
                  <th style="text-align:right;">Hours</th>
                  <th style="text-align:right;">Sessions</th>
                  <th style="text-align:right;">Weeks</th>
                  <th style="text-align:right;">Avg/wk</th>
                  <th>Top category</th>
                </tr>
              </thead>
              <tbody>
                {% for r in compare_rows %}
                  {% set is_sel = (selected_season and r.id == selected_season.id) %}
                  <tr {% if is_sel %}style="outline: 2px solid var(--theme-color-primary);"{% endif %}>
                    <td>
                      <a href="{{ url_for('views.season_view', season_id=r.id) }}">{{ r.name }}</a>
                      {% if r.is_in_progress %}
                        <span style="font-size:0.9em; opacity:0.75;">(to date)</span>
                      {% endif %}
                    </td>
                    <td>{{ r.start_date }} → {{ r.end_date }}</td>
                    <td style="text-align:right;">{{ "%.1f"|format(r.total_hours) }}</td>
                    <td style="text-align:right;">{{ r.sessions }}</td>
                    <td style="text-align:right;">{{ r.weeks }}</td>
                    <td style="text-align:right;">{{ "%.1f"|format(r.avg_hours_per_week) }}</td>
                    <td>{{ r.top_category or "—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

        {% else %}
        <p>No active season found. Pick one from the list (or mark one active in Admin).</p>
        {% endif %}

    {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% if weekly and weekly.weeks and weekly.weeks|length %}
<script>
  (function () {
    const weekly = {{ weekly | tojson }};
    if (!weekly || !weekly.weeks || !weekly.weeks.length) {
      return;
    }

    const labels = weekly.weeks.map(w => w.label);
    const data = weekly.weeks.map(w => Number(w.hours) || 0);

    const canvas = document.getElementById("seasonWeeklyChart");
    if (!canvas) {
      return;
    }

    // Prevent duplicate charts on reload / navigation
    if (canvas._chartInstance) {
      canvas._chartInstance.destroy();
    }

    const chart = new Chart(canvas.getContext("2d"), {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Hours",
          data: data,
          borderRadius: 6,
          backgroundColor: "rgba(54, 162, 235, 0.85)",
          borderColor: "rgba(54, 162, 235, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: {
          x: {
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: {
              callback: (value) => value + " h"
            }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => ctx.parsed.y.toFixed(1) + " hours"
            }
          }
        }
      }
    });

    canvas._chartInstance = chart;
  })();
</script>
{% endif %}


{% if items and items|length %}
<script>
  (function () {
    const breakdown = {{ breakdown | tojson }};
    const items = (breakdown && breakdown["items"]) ? breakdown["items"] : [];
    if (!items.length) return;

    const labels = items.map(x => x["label"]);
    const data = items.map(x => Number(x["hours"]) || 0);

    const canvas = document.getElementById("seasonDonutChart");
    if (!canvas) return;

    if (canvas._chartInstance) {
      canvas._chartInstance.destroy();
    }

    canvas._chartInstance = new Chart(canvas.getContext("2d"), {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "62%",
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const v = ctx.parsed ?? 0;
                const total = data.reduce((a, b) => a + b, 0) || 1;
                const pct = (v / total) * 100;
                return `${ctx.label}: ${v.toFixed(1)} h (${pct.toFixed(0)}%)`;
              }
            }
          }
        }
      }
    });
  })();
</script>
{% endif %}

{% endblock %}
